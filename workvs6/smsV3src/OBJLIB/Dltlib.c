//
// Easy Scanner System Ver1.0
//
// ess  dltlib.c	曲線処理関数
//
//  Copyright (c) 1998 by THEON

#include	<windows.h>

#include	<stdio.h>
#include	<math.h>

#include	"..\stdef.h"
#include	"dlldef.h"

#include	"dltlib.fnc"

int dlt_tan[] = {		//ds ＴＡＮテーブル
/* xx    xx00  xx10  xx20  xx30  xx40  xx50 */
/* 00 */    1,   29,   58,   87,  116,  145,
/* 01 */  175,  204,  233,  262,  291,  320,
/* 02 */  349,  378,  407,  437,  466,  495,
/* 03 */  524,  553,  582,  612,  641,  670,
/* 04 */  699,  729,  758,  787,  816,  846,

/* 05 */  875,  904,  934,  963,  992, 1022,
/* 06 */ 1051, 1080, 1110, 1139, 1169, 1198,
/* 07 */ 1228, 1257, 1287, 1317, 1346, 1376,
/* 08 */ 1405, 1435, 1465, 1495, 1524, 1554,
/* 09 */ 1584, 1614, 1644, 1673, 1703, 1733,

/* 10 */ 1763, 1793, 1823, 1853, 1883, 1914,
/* 11 */ 1944, 1974, 2004, 2035, 2065, 2095,
/* 12 */ 2126, 2156, 2186, 2217, 2247, 2278,
/* 13 */ 2309, 2339, 2370, 2401, 2432, 2462,
/* 14 */ 2493, 2524, 2555, 2586, 2617, 2648,

/* 15 */ 2679, 2711, 2742, 2773, 2805, 2836,
/* 16 */ 2867, 2899, 2931, 2962, 2994, 3026,
/* 17 */ 3057, 3089, 3121, 3153, 3185, 3217,
/* 18 */ 3249, 3281, 3314, 3346, 3378, 3411,
/* 19 */ 3443, 3476, 3508, 3541, 3574, 3607,

/* 20 */ 3640, 3673, 3706, 3739, 3772, 3805,
/* 21 */ 3839, 3872, 3906, 3939, 3973, 4006,
/* 22 */ 4040, 4074, 4108, 4142, 4176, 4210,
/* 23 */ 4245, 4279, 4314, 4348, 4383, 4417,
/* 24 */ 4452, 4487, 4522, 4557, 4592, 4628,

/* 25 */ 4663, 4699, 4734, 4770, 4806, 4841,
/* 26 */ 4877, 4913, 4950, 4986, 5022, 5059,
/* 27 */ 5095, 5132, 5169, 5206, 5243, 5280,
/* 28 */ 5317, 5354, 5392, 5430, 5467, 5505,
/* 29 */ 5543, 5581, 5619, 5658, 5696, 5735,

/* 30 */ 5774, 5812, 5851, 5890, 5930, 5969,
/* 31 */ 6009, 6048, 6088, 6128, 6168, 6208,
/* 32 */ 6249, 6289, 6330, 6371, 6412, 6453,
/* 33 */ 6494, 6536, 6577, 6619, 6661, 6703,
/* 34 */ 6745, 6787, 6830, 6873, 6916, 6959,

/* 35 */ 7002, 7046, 7089, 7133, 7177, 7221,
/* 36 */ 7265, 7310, 7355, 7400, 7445, 7490,
/* 37 */ 7536, 7581, 7627, 7673, 7720, 7766,
/* 38 */ 7813, 7860, 7907, 7954, 8002, 8050,
/* 39 */ 8098, 8146, 8195, 8243, 8292, 8342,

/* 40 */ 8391, 8441, 8491, 8541, 8591, 8642,
/* 41 */ 8693, 8744, 8796, 8847, 8899, 8952,
/* 42 */ 9004, 9057, 9110, 9163, 9217, 9271,
/* 43 */ 9325, 9380, 9435, 9490, 9545, 9601,
/* 44 */ 9657, 9713, 9770, 9827, 9884, 9942,

/* 45 */ 10000, -1
};


int dlt_sin[] = {		//ds ＳＩＮテーブル
/* xx    xx00  xx10  xx20  xx30  xx40  xx50 */
/* 00 */    0,   29,   58,   87,  116,  145,
/* 01 */  175,  204,  233,  262,  291,  320,
/* 02 */  349,  378,  407,  436,  465,  494,
/* 03 */  523,  552,  581,  610,  640,  669,
/* 04 */  698,  727,  756,  785,  814,  843,

/* 05 */  872,  901,  929,  958,  987, 1016,
/* 06 */ 1045, 1074, 1103, 1132, 1161, 1190,
/* 07 */ 1219, 1248, 1276, 1305, 1334, 1363,
/* 08 */ 1392, 1421, 1449, 1478, 1507, 1536,
/* 09 */ 1564, 1593, 1622, 1650, 1679, 1708,

/* 10 */ 1736, 1765, 1794, 1822, 1851, 1880,
/* 11 */ 1908, 1937, 1965, 1994, 2022, 2051,
/* 12 */ 2079, 2108, 2136, 2164, 2193, 2221,
/* 13 */ 2250, 2278, 2306, 2334, 2363, 2391,
/* 14 */ 2419, 2447, 2476, 2504, 2532, 2560,

/* 15 */ 2588, 2616, 2644, 2672, 2700, 2728,
/* 16 */ 2756, 2784, 2812, 2840, 2868, 2896,
/* 17 */ 2924, 2952, 2979, 3007, 3035, 3062,
/* 18 */ 3090, 3118, 3145, 3173, 3201, 3228,
/* 19 */ 3256, 3283, 3311, 3338, 3365, 3393,

/* 20 */ 3420, 3448, 3475, 3502, 3529, 3557,
/* 21 */ 3584, 3611, 3638, 3665, 3692, 3719,
/* 22 */ 3746, 3773, 3800, 3827, 3854, 3881,
/* 23 */ 3907, 3934, 3961, 3987, 4014, 4041,
/* 24 */ 4067, 4094, 4120, 4147, 4173, 4200,

/* 25 */ 4226, 4253, 4279, 4305, 4331, 4358,
/* 26 */ 4384, 4410, 4436, 4462, 4488, 4514,
/* 27 */ 4540, 4566, 4592, 4617, 4643, 4669,
/* 28 */ 4695, 4720, 4746, 4772, 4797, 4823,
/* 29 */ 4848, 4874, 4899, 4924, 4950, 4975,

/* 30 */ 5000, 5025, 5050, 5075, 5100, 5125,
/* 31 */ 5150, 5175, 5200, 5225, 5250, 5275,
/* 32 */ 5299, 5324, 5348, 5373, 5398, 5422,
/* 33 */ 5446, 5471, 5495, 5519, 5544, 5568,
/* 34 */ 5592, 5616, 5640, 5664, 5688, 5712,

/* 35 */ 5736, 5760, 5783, 5807, 5831, 5854,
/* 36 */ 5878, 5901, 5925, 5948, 5972, 5995,
/* 37 */ 6018, 6041, 6065, 6088, 6111, 6134,
/* 38 */ 6157, 6180, 6202, 6225, 6248, 6271,
/* 39 */ 6293, 6316, 6338, 6361, 6383, 6406,

/* 40 */ 6428, 6450, 6472, 6494, 6517, 6539,
/* 41 */ 6561, 6583, 6604, 6626, 6648, 6670,
/* 42 */ 6691, 6713, 6734, 6756, 6777, 6799,
/* 43 */ 6820, 6841, 6862, 6884, 6905, 6926,
/* 44 */ 6947, 6957, 6988, 7009, 7030, 7050,



/* xx    xx00  xx10  xx20  xx30  xx40  xx50 */
/* 45 */ 7071, 7092, 7112, 7133, 7153, 7173,
/* 46 */ 7193, 7214, 7234, 7254, 7274, 7294,
/* 47 */ 7314, 7333, 7353, 7373, 7392, 7412,
/* 48 */ 7431, 7451, 7470, 7490, 7509, 7528,
/* 49 */ 7547, 7566, 7585, 7604, 7623, 7642,

/* 50 */ 7660, 7679, 7698, 7716, 7735, 7753,
/* 51 */ 7771, 7790, 7808, 7826, 7844, 7862,
/* 52 */ 7880, 7898, 7916, 7934, 7951, 7969,
/* 53 */ 7986, 8004, 8021, 8039, 8056, 8073,
/* 54 */ 8090, 8107, 8124, 8141, 8158, 8175,

/* 55 */ 8192, 8208, 8225, 8241, 8258, 8274,
/* 56 */ 8290, 8307, 8323, 8339, 8355, 8371,
/* 57 */ 8387, 8403, 8418, 8434, 8450, 8465,
/* 58 */ 8480, 8496, 8511, 8526, 8542, 8557,
/* 59 */ 8572, 8587, 8601, 8616, 8631, 8646,

/* 60 */ 8660, 8675, 8689, 8704, 8718, 8732,
/* 61 */ 8746, 8760, 8774, 8788, 8802, 8816,
/* 62 */ 8829, 8843, 8857, 8870, 8884, 8897,
/* 63 */ 8910, 8923, 8936, 8949, 8962, 8975,
/* 64 */ 8988, 9001, 9013, 9026, 9036, 9051,

/* 65 */ 9063, 9075, 9088, 9100, 9112, 9124,
/* 66 */ 9135, 9147, 9159, 9171, 9182, 9194,
/* 67 */ 9205, 9216, 9228, 9239, 9250, 9261,
/* 68 */ 9272, 9283, 9293, 9304, 9315, 9325,
/* 69 */ 9336, 9346, 9356, 9367, 9377, 9387,

/* 70 */ 9397, 9407, 9417, 9426, 9436, 9446,
/* 71 */ 9455, 9465, 9474, 9483, 9492, 9502,
/* 72 */ 9511, 9520, 9528, 9537, 9546, 9555,
/* 73 */ 9563, 9572, 9580, 9588, 9596, 9605,
/* 74 */ 9613, 9621, 9628, 9636, 9644, 9652,

/* 75 */ 9659, 9667, 9674, 9681, 9689, 9696,
/* 76 */ 9703, 9710, 9717, 9724, 9730, 9737,
/* 77 */ 9744, 9750, 9757, 9763, 9769, 9775,
/* 78 */ 9781, 9787, 9793, 9799, 9805, 9811,
/* 79 */ 9816, 9822, 9827, 9833, 9838, 9843,

/* 80 */ 9848, 9853, 9858, 9863, 9868, 9872,
/* 81 */ 9877, 9881, 9886, 9890, 9894, 9899,
/* 82 */ 9903, 9907, 9911, 9914, 9918, 9922,
/* 83 */ 9925, 9929, 9932, 9936, 9939, 9942,
/* 84 */ 9945, 9948, 9951, 9954, 9957, 9959,

/* 85 */ 9962, 9964, 9967, 9969, 9971, 9974,
/* 86 */ 9976, 9978, 9980, 9981, 9983, 9985,
/* 87 */ 9986, 9988, 9989, 9990, 9992, 9993,
/* 88 */ 9994, 9995, 9996, 9997, 9997, 9998,
/* 89 */ 9998, 9999, 9999, 10000, 10000, 10000,
/* 90 */ 10000, -1
};

//p 角度を求める関数  0 <= angl < 360 * 6
DllExport int dlt_rag(int xd, int yd)
{
	int	angl;

	angl = dlt_lrag((long)xd, (long)yd);
	return(angl);
}

//p 角度を求める関数 0 <= angl < 360 * 6
DllExport int dlt_lrag(long xd, long yd)
{
	int		angl;
	long	axd, ayd, d;

	axd = (long)fabs(xd);
	ayd = (long)fabs(yd);
	if(axd == 0){
		angl = 90 * 6;
	}
	else if(ayd == 0){
		angl = 0;
	}
	else if(axd == ayd){
		angl = 45 * 6;
	}
	else if(xd == 0 && yd == 0){
		angl = 0;
	}
	else if(axd > ayd){ /* 0 < angl < 45 */
		d = (ayd * 10000L) / axd;
		angl = tantblsrch((int)d);
	}
	else
	{
		d = (axd * 10000L) / ayd;
		angl = tantblsrch((int)d);
		angl = (90 * 6) - angl;
	}
	if(xd < 0L && yd > 0L){
		angl = (180 * 6) - angl;
	}
	else if(xd <= 0L && yd <= 0L){
		angl += (180 * 6);
	}
	else if(xd > 0L && yd < 0L){
		if(angl != 0){
			angl = (360 * 6) - angl;
		}
	}
	return(angl);
}

//p tan値を求める関数
DllExport int dlt_tan_num(int angl)
{
	long	dat;

	angl %= (180 * 6);
	if(angl < 0){
		angl += (180 * 6);
	}
	if(angl == 0 || angl == (180 * 6)){
		return(0);
	}
	if(angl == (45 * 6)){
		return(100);
	}
	if(angl == (90 * 6) || angl == (90 * 6 - 1)){
		return(32700);
	}
	if(angl == (135 * 6)){
		return(-100);
	}
	if(angl < (45 * 6)){
		dat = (long)dlt_tan[angl];
		dat = (dat + 50L) / 100L;

		return((int)dat);
	}		
	if(angl < (90 * 6)){
		angl = (90 * 6) - angl;	

		dat = (long)dlt_tan[angl];
		dat = 100000000L / dat;
		dat = (dat + 50L) / 100L;

		return((int)dat);
	}
	if(angl < (135 * 6)){
		angl = angl - (90 * 6);

		dat = (long)dlt_tan[angl];
		dat = 100000000L / dat;
		dat = (dat + 50L) / 100L;
		dat = -dat;

		return((int)dat);
	}
	if(angl < (180 * 6)){
		angl = (180 * 6) - angl;
		dat = (long)dlt_tan[angl];
		dat = (dat + 50L) / 100L;
		dat = -dat;

		return((int)dat);
	}
	return(0);
}

//p cos値を求める関数
DllExport int dlt_cos_num(int angl)
{
	DBL	dret;
	int	ret;
	
	dret = dlt_dcos_num(angl);
	ret = (int)(dret * 100.0);
	return(ret);
}

//p sin値を求める関数
DllExport int dlt_sin_num(int angl)
{
	DBL	dret;
	int	ret;
	
	dret = dlt_dsin_num(angl);
	ret = (int)(dret * 100.0);
	return(ret);
}

//p cos値を求める関数
DllExport DBL dlt_dcos_num(int angl)
{
	int	base, ret;
	DBL	dret;

	angl %= (360 * 6);
	if(angl < 0){
		angl += (360 * 6);
	}
	base = angl / (90 * 6);
	switch(base){
	  case 0:
		angl = (90 * 6) - angl;
		ret = dlt_sin[angl];
		break;
	  case 1:
		angl = angl - (90 * 6);
		ret = dlt_sin[angl];
		ret *= -1;
		break;
	  case 2:
		angl = (270 * 6) - angl;
		ret = dlt_sin[angl];
		ret *= -1;
		break;
	  case 3:
		angl = angl - (270 * 6);
		ret = dlt_sin[angl];
		break;
	}
	dret = ret;
	dret /= 10000.0;
	return(dret);
}

//p sin値を求める関数
DllExport DBL dlt_dsin_num(int angl)
{
	int	base, ret;
	DBL	dret;

	angl %= (360 * 6);
	if(angl < 0){
		angl += (360 * 6);
	}
	base = angl / (90 * 6);
	switch(base){
	  case 0:
		ret = dlt_sin[angl];
		break;
	  case 1:
		angl = (180 * 6) - angl;
		ret = dlt_sin[angl];
		break;
	  case 2:
		angl = angl - (180 * 6);
		ret = dlt_sin[angl];
		ret *= -1;
		break;
	  case 3:
		angl = (360 * 6) - angl;
		ret = dlt_sin[angl];
		ret *= -1;
		break;
	}
	dret = ret;
	dret /= 10000.0;
	return(dret);
}

//p tanテーブルから値を求める関数
DllExport int tantblsrch(int dlt)
{
	int	i;
	int	angl;

	if(dlt == 10000){
		angl = 45 * 6;
		return(angl);
	}
	for(i = 0; dlt_tan[i] != -1; i++){
		if(dlt_tan[i] == dlt){
			angl = i;
			return(angl);
		}
		if(dlt_tan[i] > dlt){
			if((dlt_tan[i] - dlt) < (dlt - dlt_tan[i - 1])){
				angl = i;
				return(angl);
			}
			else{
				angl = (i - 1);
				return(angl);
			}
		}
	}
	printf("tan search Error %d\n", dlt);
	return(0);
}

